{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://bac4.io/schemas/integration-definition/v1.0.0",
  "title": "BAC4 Integration Definition",
  "description": "Schema for defining enterprise integration patterns and configurations",
  "type": "object",
  "required": ["version", "info", "integrations"],
  "properties": {
    "version": {
      "type": "string",
      "description": "Version of the BAC4 Integration Definition specification",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "examples": ["1.0.0"]
    },
    "info": {
      "type": "object",
      "description": "Metadata about the integration definition",
      "required": ["title", "version"],
      "properties": {
        "title": {
          "type": "string",
          "description": "Name of the integration landscape or project"
        },
        "version": {
          "type": "string",
          "description": "Version of this integration definition document",
          "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
        },
        "description": {
          "type": "string",
          "description": "Description of the integration landscape"
        },
        "contact": {
          "type": "object",
          "properties": {
            "name": {"type": "string"},
            "email": {"type": "string", "format": "email"},
            "url": {"type": "string", "format": "uri"}
          }
        },
        "license": {
          "type": "object",
          "properties": {
            "name": {"type": "string"},
            "url": {"type": "string", "format": "uri"}
          }
        },
        "tags": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Tags for categorization and search"
        }
      }
    },
    "systems": {
      "type": "object",
      "description": "Dictionary of systems participating in integrations",
      "additionalProperties": {
        "$ref": "#/$defs/System"
      }
    },
    "integrations": {
      "type": "array",
      "description": "Array of integration definitions",
      "items": {
        "$ref": "#/$defs/Integration"
      },
      "minItems": 1
    },
    "components": {
      "type": "object",
      "description": "Reusable components (schemas, security schemes, parameters, etc.)",
      "properties": {
        "schemas": {
          "type": "object",
          "additionalProperties": {
            "$ref": "https://json-schema.org/draft/2020-12/schema"
          }
        },
        "securitySchemes": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/SecurityScheme"
          }
        },
        "parameters": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/Parameter"
          }
        },
        "transformations": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/Transformation"
          }
        }
      }
    }
  },
  "$defs": {
    "System": {
      "type": "object",
      "description": "A system or application participating in integrations",
      "required": ["name", "type"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Display name of the system"
        },
        "type": {
          "type": "string",
          "enum": ["application", "database", "service", "external", "legacy"],
          "description": "Type of system"
        },
        "description": {
          "type": "string"
        },
        "version": {
          "type": "string"
        },
        "owner": {
          "type": "string",
          "description": "Team or person responsible for the system"
        },
        "environment": {
          "type": "string",
          "enum": ["development", "test", "staging", "production"],
          "description": "Environment where the system is deployed"
        },
        "metadata": {
          "type": "object",
          "additionalProperties": true
        }
      }
    },
    "Integration": {
      "type": "object",
      "description": "Defines a single integration flow",
      "required": ["id", "name", "pattern", "source", "target"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the integration",
          "pattern": "^[a-zA-Z0-9_-]+$"
        },
        "name": {
          "type": "string",
          "description": "Human-readable name"
        },
        "description": {
          "type": "string"
        },
        "pattern": {
          "type": "string",
          "enum": ["rest-api", "soap-api", "messaging", "event-stream", "batch", "file-transfer", "database-sync", "custom"],
          "description": "Integration pattern type"
        },
        "source": {
          "$ref": "#/$defs/Endpoint",
          "description": "Source endpoint of the integration"
        },
        "target": {
          "$ref": "#/$defs/Endpoint",
          "description": "Target endpoint of the integration"
        },
        "trigger": {
          "$ref": "#/$defs/Trigger",
          "description": "What triggers this integration"
        },
        "transformation": {
          "$ref": "#/$defs/Transformation",
          "description": "Data transformation logic"
        },
        "errorHandling": {
          "$ref": "#/$defs/ErrorHandling",
          "description": "Error handling strategy"
        },
        "security": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/SecurityRequirement"
          },
          "description": "Security requirements for this integration"
        },
        "metadata": {
          "type": "object",
          "properties": {
            "sla": {
              "type": "object",
              "properties": {
                "latency": {"type": "string", "description": "Expected latency (e.g., '100ms', '5s')"},
                "throughput": {"type": "string", "description": "Expected throughput (e.g., '1000/sec', '10MB/min')"},
                "availability": {"type": "string", "description": "Expected availability (e.g., '99.9%')"}
              }
            },
            "owner": {"type": "string"},
            "tags": {
              "type": "array",
              "items": {"type": "string"}
            },
            "documentation": {
              "type": "string",
              "format": "uri"
            }
          },
          "additionalProperties": true
        },
        "config": {
          "type": "object",
          "description": "Pattern-specific configuration",
          "oneOf": [
            {"$ref": "#/$defs/RestApiConfig"},
            {"$ref": "#/$defs/SoapApiConfig"},
            {"$ref": "#/$defs/MessagingConfig"},
            {"$ref": "#/$defs/EventStreamConfig"},
            {"$ref": "#/$defs/BatchConfig"},
            {"$ref": "#/$defs/FileTransferConfig"},
            {"$ref": "#/$defs/DatabaseSyncConfig"},
            {"$ref": "#/$defs/CustomConfig"}
          ]
        }
      }
    },
    "Endpoint": {
      "type": "object",
      "description": "Defines an integration endpoint",
      "required": ["system"],
      "properties": {
        "system": {
          "type": "string",
          "description": "Reference to a system defined in the systems dictionary"
        },
        "protocol": {
          "type": "string",
          "enum": ["http", "https", "ftp", "sftp", "kafka", "amqp", "mqtt", "jdbc", "odbc", "custom"],
          "description": "Communication protocol"
        },
        "connection": {
          "type": "object",
          "properties": {
            "url": {"type": "string"},
            "host": {"type": "string"},
            "port": {"type": "integer"},
            "path": {"type": "string"},
            "database": {"type": "string"},
            "topic": {"type": "string"},
            "queue": {"type": "string"}
          },
          "additionalProperties": true
        },
        "format": {
          "type": "string",
          "enum": ["json", "xml", "csv", "avro", "parquet", "protobuf", "text", "binary"],
          "description": "Data format"
        },
        "schema": {
          "oneOf": [
            {"type": "string", "description": "Reference to a schema in components"},
            {"type": "object", "description": "Inline JSON Schema"}
          ]
        }
      }
    },
    "Trigger": {
      "type": "object",
      "description": "Defines what triggers the integration",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["schedule", "event", "api-call", "file-arrival", "database-change", "manual", "webhook"],
          "description": "Type of trigger"
        },
        "schedule": {
          "type": "object",
          "description": "Schedule configuration (for scheduled triggers)",
          "properties": {
            "cron": {"type": "string", "description": "Cron expression"},
            "interval": {"type": "string", "description": "Interval (e.g., '5m', '1h', '1d')"},
            "timezone": {"type": "string", "description": "Timezone (e.g., 'UTC', 'America/New_York')"}
          }
        },
        "event": {
          "type": "object",
          "description": "Event configuration (for event-driven triggers)",
          "properties": {
            "source": {"type": "string"},
            "type": {"type": "string"},
            "filter": {"type": "object", "description": "CloudEvents-style filter"}
          }
        },
        "webhook": {
          "type": "object",
          "properties": {
            "path": {"type": "string"},
            "method": {"type": "string", "enum": ["GET", "POST", "PUT", "PATCH", "DELETE"]}
          }
        }
      }
    },
    "Transformation": {
      "type": "object",
      "description": "Data transformation logic",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["mapping", "template", "script", "reference"],
          "description": "Type of transformation"
        },
        "mapping": {
          "type": "object",
          "description": "Field-to-field mapping",
          "additionalProperties": {
            "oneOf": [
              {"type": "string", "description": "Source field path or expression"},
              {"type": "object", "description": "Complex mapping with functions"}
            ]
          }
        },
        "template": {
          "type": "string",
          "description": "Template string (e.g., JSONata, Handlebars, Jinja2)"
        },
        "templateEngine": {
          "type": "string",
          "enum": ["jsonata", "handlebars", "jinja2", "velocity", "mustache"],
          "description": "Template engine to use"
        },
        "script": {
          "type": "object",
          "properties": {
            "language": {"type": "string", "enum": ["javascript", "python", "groovy", "java"]},
            "inline": {"type": "string"},
            "file": {"type": "string"}
          }
        },
        "reference": {
          "type": "string",
          "description": "Reference to a transformation in components"
        }
      }
    },
    "ErrorHandling": {
      "type": "object",
      "description": "Error handling strategy",
      "properties": {
        "retry": {
          "type": "object",
          "properties": {
            "maxAttempts": {"type": "integer", "minimum": 1},
            "backoff": {
              "type": "string",
              "enum": ["fixed", "exponential", "linear"]
            },
            "delay": {"type": "string", "description": "Initial delay (e.g., '1s', '5s')"},
            "maxDelay": {"type": "string", "description": "Maximum delay for backoff"}
          }
        },
        "deadLetterQueue": {
          "type": "object",
          "properties": {
            "enabled": {"type": "boolean"},
            "endpoint": {"$ref": "#/$defs/Endpoint"}
          }
        },
        "alerting": {
          "type": "object",
          "properties": {
            "enabled": {"type": "boolean"},
            "channels": {
              "type": "array",
              "items": {"type": "string", "enum": ["email", "slack", "pagerduty", "webhook"]}
            },
            "recipients": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        },
        "fallback": {
          "type": "object",
          "properties": {
            "enabled": {"type": "boolean"},
            "action": {"type": "string", "enum": ["skip", "default-value", "alternative-endpoint"]},
            "defaultValue": {},
            "alternativeEndpoint": {"$ref": "#/$defs/Endpoint"}
          }
        }
      }
    },
    "SecurityScheme": {
      "type": "object",
      "description": "Defines a security scheme",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["apiKey", "http", "oauth2", "openIdConnect", "mutual-tls", "custom"]
        },
        "description": {"type": "string"},
        "name": {"type": "string"},
        "in": {"type": "string", "enum": ["query", "header", "cookie"]},
        "scheme": {"type": "string", "description": "HTTP auth scheme (e.g., 'bearer', 'basic')"},
        "bearerFormat": {"type": "string"},
        "flows": {
          "type": "object",
          "description": "OAuth2 flows"
        },
        "openIdConnectUrl": {"type": "string", "format": "uri"}
      }
    },
    "SecurityRequirement": {
      "type": "object",
      "description": "Reference to a security scheme with scopes",
      "additionalProperties": {
        "type": "array",
        "items": {"type": "string"}
      }
    },
    "Parameter": {
      "type": "object",
      "properties": {
        "name": {"type": "string"},
        "in": {"type": "string", "enum": ["query", "header", "path", "cookie"]},
        "description": {"type": "string"},
        "required": {"type": "boolean"},
        "schema": {}
      }
    },
    "RestApiConfig": {
      "type": "object",
      "description": "REST API specific configuration",
      "properties": {
        "method": {
          "type": "string",
          "enum": ["GET", "POST", "PUT", "PATCH", "DELETE", "HEAD", "OPTIONS"]
        },
        "path": {"type": "string"},
        "headers": {
          "type": "object",
          "additionalProperties": {"type": "string"}
        },
        "queryParameters": {
          "type": "object",
          "additionalProperties": {"type": "string"}
        },
        "requestBody": {
          "type": "object",
          "properties": {
            "contentType": {"type": "string"},
            "schema": {}
          }
        },
        "responseExpected": {
          "type": "object",
          "properties": {
            "statusCode": {"type": "integer"},
            "schema": {}
          }
        },
        "timeout": {"type": "string", "description": "Timeout (e.g., '30s', '5m')"},
        "pagination": {
          "type": "object",
          "properties": {
            "type": {"type": "string", "enum": ["offset", "cursor", "page"]},
            "pageSize": {"type": "integer"}
          }
        }
      }
    },
    "SoapApiConfig": {
      "type": "object",
      "description": "SOAP API specific configuration",
      "properties": {
        "wsdlUrl": {"type": "string", "format": "uri"},
        "operation": {"type": "string"},
        "soapVersion": {"type": "string", "enum": ["1.1", "1.2"]},
        "headers": {
          "type": "object",
          "properties": {
            "action": {"type": "string"}
          },
          "additionalProperties": {"type": "string"}
        }
      }
    },
    "MessagingConfig": {
      "type": "object",
      "description": "Messaging (MQ) specific configuration",
      "properties": {
        "provider": {
          "type": "string",
          "enum": ["rabbitmq", "activemq", "ibm-mq", "azure-servicebus", "aws-sqs", "google-pubsub"]
        },
        "queueName": {"type": "string"},
        "topicName": {"type": "string"},
        "exchangeType": {"type": "string", "enum": ["direct", "topic", "fanout", "headers"]},
        "routingKey": {"type": "string"},
        "durable": {"type": "boolean"},
        "exclusive": {"type": "boolean"},
        "autoAck": {"type": "boolean"},
        "prefetchCount": {"type": "integer"},
        "messageProperties": {
          "type": "object",
          "properties": {
            "contentType": {"type": "string"},
            "contentEncoding": {"type": "string"},
            "deliveryMode": {"type": "integer"},
            "priority": {"type": "integer"},
            "correlationId": {"type": "string"},
            "replyTo": {"type": "string"},
            "expiration": {"type": "string"},
            "messageId": {"type": "string"},
            "timestamp": {"type": "string"},
            "type": {"type": "string"},
            "userId": {"type": "string"},
            "appId": {"type": "string"}
          }
        }
      }
    },
    "EventStreamConfig": {
      "type": "object",
      "description": "Event streaming (Kafka) specific configuration",
      "properties": {
        "provider": {
          "type": "string",
          "enum": ["kafka", "confluent", "aws-kinesis", "azure-eventhub", "google-pubsub"]
        },
        "topic": {"type": "string"},
        "partitions": {"type": "integer"},
        "replicationFactor": {"type": "integer"},
        "consumerGroup": {"type": "string"},
        "offsetReset": {"type": "string", "enum": ["earliest", "latest", "none"]},
        "enableAutoCommit": {"type": "boolean"},
        "maxPollRecords": {"type": "integer"},
        "compression": {"type": "string", "enum": ["none", "gzip", "snappy", "lz4", "zstd"]},
        "idempotence": {"type": "boolean"},
        "transactionalId": {"type": "string"},
        "cloudEvents": {
          "type": "boolean",
          "description": "Whether to use CloudEvents format"
        }
      }
    },
    "BatchConfig": {
      "type": "object",
      "description": "Batch processing specific configuration",
      "properties": {
        "chunkSize": {"type": "integer", "description": "Number of records per batch"},
        "parallelism": {"type": "integer", "description": "Degree of parallelism"},
        "ordering": {"type": "string", "enum": ["preserve", "unordered"]},
        "checkpointing": {
          "type": "object",
          "properties": {
            "enabled": {"type": "boolean"},
            "interval": {"type": "string"}
          }
        },
        "aggregation": {
          "type": "object",
          "properties": {
            "enabled": {"type": "boolean"},
            "window": {"type": "string", "description": "Time window (e.g., '5m', '1h')"},
            "function": {"type": "string", "enum": ["sum", "avg", "count", "min", "max", "custom"]}
          }
        }
      }
    },
    "FileTransferConfig": {
      "type": "object",
      "description": "File transfer specific configuration",
      "properties": {
        "protocol": {"type": "string", "enum": ["ftp", "sftp", "ftps", "scp", "http", "https", "s3", "azure-blob", "gcs"]},
        "directory": {"type": "string"},
        "filePattern": {"type": "string", "description": "Glob pattern or regex"},
        "polling": {
          "type": "object",
          "properties": {
            "enabled": {"type": "boolean"},
            "interval": {"type": "string"}
          }
        },
        "compression": {
          "type": "object",
          "properties": {
            "enabled": {"type": "boolean"},
            "format": {"type": "string", "enum": ["gzip", "zip", "tar", "tar.gz"]}
          }
        },
        "encryption": {
          "type": "object",
          "properties": {
            "enabled": {"type": "boolean"},
            "algorithm": {"type": "string"},
            "keyId": {"type": "string"}
          }
        },
        "archiving": {
          "type": "object",
          "properties": {
            "enabled": {"type": "boolean"},
            "directory": {"type": "string"},
            "retention": {"type": "string", "description": "Retention period (e.g., '30d', '1y')"}
          }
        },
        "fileProcessing": {
          "type": "object",
          "properties": {
            "moveAfterProcessing": {"type": "boolean"},
            "deleteAfterProcessing": {"type": "boolean"},
            "targetDirectory": {"type": "string"}
          }
        }
      }
    },
    "DatabaseSyncConfig": {
      "type": "object",
      "description": "Database synchronization specific configuration",
      "properties": {
        "syncType": {"type": "string", "enum": ["full", "incremental", "cdc"]},
        "table": {"type": "string"},
        "query": {"type": "string"},
        "keyColumns": {
          "type": "array",
          "items": {"type": "string"}
        },
        "incrementalColumn": {"type": "string"},
        "cdcMethod": {"type": "string", "enum": ["timestamp", "version", "trigger", "log-based"]},
        "conflictResolution": {"type": "string", "enum": ["source-wins", "target-wins", "latest-wins", "manual"]},
        "bulkLoad": {
          "type": "object",
          "properties": {
            "enabled": {"type": "boolean"},
            "batchSize": {"type": "integer"}
          }
        }
      }
    },
    "CustomConfig": {
      "type": "object",
      "description": "Custom integration pattern configuration",
      "properties": {
        "type": {"type": "string"},
        "config": {
          "type": "object",
          "additionalProperties": true
        }
      }
    }
  }
}
